# 交貨日期估算器 - 需求規格書

**版本：** 2.7 (部分履約版本與多重日期追蹤)  
**日期：** 民國114年8月 (2025年8月)  
**平台：** 現代網頁瀏覽器 (Chrome, Firefox, Safari, Edge)  
**函式庫：** SheetJS (XLSX.js) 用於Excel檔案處理  
**部署方式：** 單一HTML檔案 - 無需安裝  
**日曆系統：** 中華民國114年 (2025年) 官方營業日曆  
**重要更新：** 部分履約支援多重交貨日期與加強型排序邏輯

## 1. 系統概述

基於瀏覽器的JavaScript應用程式，使用**部分履約分配邏輯**處理客戶訂單，根據庫存可用性和航班抵達時程估算交貨日期。系統在客戶端讀取三個Excel檔案，並產生詳細分配追蹤、**多重交貨日期支援**、完整無法解析資料處理、與**中華民國114年 (2025年) 官方營業日曆**整合的**倉庫提貨規則**，以及**零緩衝天數預設**的當日現貨交貨的交貨估算。

**主要優勢：**
- **零安裝**：直接在網頁瀏覽器中執行
- **部分履約邏輯**：使用可用庫存最大限度履行訂單
- **多重日期追蹤**：顯示每個使用航班的個別提貨和交貨日期
- **加強型FIFO排序**：以需求日期為主要排序，以採購單建立日期為次要排序
- **未來航班利用**：使用任何可用的未來航班，不受時間限制
- **客戶端處理**：檔案絕不離開使用者電腦
- **跨平台相容**：可在Windows、Mac、Linux、平板電腦、手機上運行
- **無相依性**：單一HTML檔案包含所有需要的功能
- **現代化界面**：響應式設計具備即時進度追蹤和多日期顯示
- **增強型除錯**：詳細控制台記錄分配決策

## 2. 輸入檔案

### 2.1 客戶訂單檔案 (`order_*.xlsx`)
- **用途：** 包含來自多個客戶檔案的客戶訂單需求
- **檔案模式：** `order_客戶代碼.xlsx` (例：`order_HZ4600.xlsx`)
- **上傳方式：** 透過瀏覽器檔案選擇器多檔案選取
- **主要欄位：**
  - `part no` - 零件識別碼 (可能包含前置詞/字首)
  - `request qty` - 客戶需求數量
  - `request date` - 客戶需要零件的日期 (YYYYMMDD格式，例："20250802")
  - `po create date` - 採購單建立日期 (用於次要排序)
  - `po` - 採購單號碼
  - `item` - 項目描述
- **注意事項：** 
  - 日期解析處理YYYYMMDD字串、Excel日期物件和Excel序號
  - **無法解析日期** (例："cancel"、"pending"、"N/A") 會被保留，訂單以無效日期狀態處理
  - 零件號碼可能包含需要限制性模糊匹配的字首
  - 客戶代碼從檔案名稱擷取 (例："order_HZ4600.xlsx" 擷取 "HZ4600")
  - 系統自動處理所有上傳的訂單檔案

### 2.2 零件庫存檔案 (`part_stock.xlsx`)
- **用途：** 目前庫存水準
- **上傳方式：** 單一檔案選取
- **主要欄位：**
  - `part no` - 零件識別碼
  - `qty` - 可用庫存數量
- **注意事項：** 
  - **即時庫存追蹤** - 系統在處理時驗證實際可用性
  - **庫存消耗** - 庫存水準隨FIFO序列中的訂單分配而減少
  - 使用限制性模糊匹配與客戶訂單零件號碼對應

### 2.3 航班資訊檔案 (`onflight.xlsx`)
- **用途：** 預定零件抵達機場的數量和日期
- **上傳方式：** 單一檔案選取
- **主要欄位：**
  - `part no` - 零件識別碼
  - `date` - **航班抵達機場日期** (各種格式)
  - `qty` - 該航班抵達數量
- **注意事項：** 
  - 允許每個零件號碼多個航班
  - 每行代表特定數量在特定日期抵達
  - **固定日期格式顯示**：顯示為 `2000×2025-08-15` 而非 `2000×45806`
  - **無法解析日期** (例："NA"、"TBD") 會被保留，航班排除在排程外
  - 必須依抵達日期排序以進行正確分配 (無法解析日期排序至末尾)

## 3. 核心業務邏輯

### 3.1 **🆕 部分履約分配系統**
- **主要規則：** 訂單按 `需求日期` 的時間順序處理 (最早優先)，以 `採購單建立日期` 作為次要排序
- **次要排序：** 當需求日期相同時，按採購單建立日期排序 (最早優先)
- **第三排序：** 訂單號碼作為最終決勝條件
- **最大履約：** 訂單使用可用庫存盡可能最大程度履行
- **未來航班利用：** 系統接受任何未來航班，不受時間限制
- **即時庫存追蹤：** 實際庫存和航班數量隨訂單分配而消耗
- **不跳過訂單：** 訂單從不跳過 - 如果有任何庫存存在，總是部分履行
- **多重交貨支援：** 當跨多個航班履行時，訂單可以有多個交貨日期

### 3.2 **🆕 加強型排序邏輯**
```javascript
// 多層級排序實作
1. 主要排序：需求日期 (升序) - 最早訂單優先
2. 次要排序：採購單建立日期 (升序) - 較早PO建立優先  
3. 第三排序：訂單號碼 (升序) - 一致的決勝條件
```

**排序行為範例：**
- 訂單A：需求日期 = 2025-08-01，PO日期 = 2025-07-15，訂單# = 100
- 訂單B：需求日期 = 2025-08-01，PO日期 = 2025-07-10，訂單# = 101  
- **處理順序：** B → A (相同需求日期，但B有較早的PO日期)

### 3.3 航班接受標準
- **接受所有未來航班：** 無緩衝天數限制 - 任何未來航班都可使用
- **早期航班：** 總是接受在訂單日期前抵達的航班
- **延遲航班：** 接受在訂單日期後抵達的所有航班 (無限延遲天數)
- **無法解析日期：** 無法解析日期的航班排除在分配外
- **最大化利用：** 系統使用每個可用航班來最大化訂單履約

### 3.4 限制性零件號碼匹配
- **目的：** 僅處理帶有"-A"後綴變體的零件號碼
- **規則：** 
  1. **精確匹配：** `part_12345678` = `part_12345678` (不區分大小寫)
  2. **後綴匹配：** `part_12345678` ↔ `part_12345678-A` (雙向)
  3. **無其他模糊匹配** - 消除誤報

### 3.5 **🆕 零緩衝天數預設**
**現貨訂單交貨：**
- **預設緩衝：** 0天 (當日交貨)
- **工作日檢查：** 如果訂單日期落在週末/假日，交貨移至下一工作日
- **可配置：** 使用者可根據需要增加緩衝天數

### 3.6 **加強型台灣工作日曆整合**
系統使用中華民國114年 (2025年) 官方營業日曆進行所有日期計算。

**中華民國114年 (2025年) 官方假日：**
1. **1月1日 (2025-01-01)** - 元旦
2. **1月27日 (2025-01-27)** - 農曆除夕
3. **1月28日 (2025-01-28)** - 春節初一
4. **1月29日 (2025-01-29)** - 春節初二
5. **1月30日 (2025-01-30)** - 春節初三
6. **1月31日 (2025-01-31)** - 春節初四
7. **2月28日 (2025-02-28)** - 和平紀念日
8. **4月3日 (2025-04-03)** - 清明節調整
9. **4月4日 (2025-04-04)** - 兒童節/清明節
10. **5月1日 (2025-05-01)** - 勞動節
11. **5月30日 (2025-05-30)** - 端午節
12. **9月29日 (2025-09-29)** - 中秋節調整
13. **10月6日 (2025-10-06)** - 中秋節
14. **10月10日 (2025-10-10)** - 國慶日
15. **10月24日 (2025-10-24)** - 補假
16. **12月25日 (2025-12-25)** - 聖誕節

### 3.7 **加強型倉庫提貨規則**
航班抵達日期代表零件抵達機場的時間。零件必須先拉入倉庫才能進行交貨。

**提貨限制：**
1. **僅週一和週三** 允許倉庫提貨作業
2. **不能在月底最後一天提貨** (作業限制)
3. **必須是台灣工作日** (排除週末和台灣假日)
4. **前置時間：** 航班抵達和提貨資格之間的最小可配置台灣工作日 (預設：2天)

**加強型提貨日期計算流程：**
1. **起始日期：** 航班抵達機場日期
2. **加上前置時間：** + 可配置台灣工作日 (排除週末和假日)
3. **找尋有效日期：** 從候選日期起的下一個週一或週三
4. **工作日檢查：** 確保選定日期是台灣工作日 (非假日)
5. **月底檢查：** 如果是月底最後一天，移至下一有效提貨日
6. **最終提貨日期：** 確認的倉庫提貨日期

### 3.8 **🆕 多重交貨日期計算**
交貨計算現在支援跨多個航班履行的訂單的多重交貨日期：

**現貨訂單：**
- **公式：** `交貨日期 = 訂單日期 + 緩衝天數 (預設：0) + 週末/假日調整`
- **單一交貨日期：** 所有庫存一次交貨
- **格式：** `"500×2025-08-01 (現貨)"`

**基於航班的訂單：**
- **公式：** `交貨日期 = 提貨日期 + 交貨前置天數 (台灣工作日)`
- **多重交貨日期：** 每個使用的航班一個日期
- **格式：** `"300×2025-08-15 (航班), 700×2025-08-25 (航班)"`

**混合訂單 (庫存 + 航班)：**
- **多重交貨日期：** 庫存和每個航班的分別日期
- **格式：** `"200×2025-08-01 (現貨), 500×2025-08-15 (航班), 300×2025-08-25 (航班)"`

**提貨日期顯示：**
- **僅庫存：** `"N/A"` (不需提貨)
- **單一航班：** `"500×2025-08-12"`
- **多個航班：** `"300×2025-08-12, 700×2025-08-22"`

## 4. 使用者介面規格

### 4.1 **檔案上傳介面**
- **視覺設計：** 基於卡片的上傳區域，具備拖放樣式
- **檔案驗證：** 檔案選取的即時回饋
- **進度指示器：** 檔案大小顯示和上傳確認
- **多檔案支援：** 支援單次選取多個訂單檔案
- **檔案類型驗證：** 僅接受.xlsx和.xls檔案

### 4.2 **配置面板**
- **互動控制項：** 具驗證和合理範圍的數字輸入
- **即時更新：** 變更立即應用於下次計算
- **可配置參數：**
  - **緩衝天數 (現貨訂單)：0-30天，預設0**
  - 航班緩衝天數 (最大延遲)：0-30天，預設0 (未使用 - 接受所有未來航班)
  - 提貨前置天數：1-10天，預設2
  - 交貨前置天數：1-10天，預設2

### 4.3 **處理介面**
- **進度條：** 檔案處理期間的即時視覺進度
- **加強型處理記錄：** 具時間戳記和詳細分配決策的即時控制台樣式記錄
- **狀態更新：** 目前處理步驟的清楚指示
- **FIFO指示器：** 顯示訂單處理序列和庫存消耗
- **錯誤顯示：** 使用者友善的錯誤訊息與自動消失

### 4.4 **🆕 具欄位重新排序的加強型結果顯示**
- **優先欄位序列 (從左到右)：**
  1. **訂單編號** - 訂單號碼
  2. **客戶代碼** - 客戶代碼  
  3. **採購單** - 採購單號碼
  4. **項目** - 項目描述
  5. **零件編號** - 零件識別碼
  6. **需求數量** - 需求數量
  7. **需求日期** - 訂單需求日期
  8. **交貨日期** - 具數量的多重交貨日期
  9. **提貨日期** - 具數量的多重提貨日期
- **附加欄位：** 履約、剩餘、PO建立日期、前置天數、狀態、庫存使用、航班數量、航班詳情、倉庫備註
- **互動功能：** 可排序欄位、多日期欄位的懸停展開、狀態色彩編碼
- **多重日期顯示：** 懸停顯示完整日期詳情的可展開儲存格

## 5. 輸出需求

### 5.1 **🆕 加強型瀏覽器結果表格**
**優先顯示欄位 (從左到右)：**
- 訂單編號、客戶代碼、PO、項目、零件編號、需求數量、需求日期
- **交貨日期**、**提貨日期**、履約、剩餘
- PO建立日期、前置天數、狀態、庫存使用、航班數量、航班詳情、倉庫備註

**🆕 多重日期顯示格式：**
- **單一庫存交貨：** `"500×2025-08-01 (現貨)"`
- **單一航班交貨：** `"500×2025-08-15 (航班)"`
- **多重交貨：** `"200×2025-08-01 (現貨), 300×2025-08-15 (航班), 500×2025-08-25 (航班)"`
- **提貨日期：** `"300×2025-08-12, 500×2025-08-22"` 或庫存專用 `"N/A"`

**互動功能：**
- **懸停展開：** 日期欄位展開顯示完整詳情
- **狀態色彩編碼：** 訂單履約狀態的視覺指示器
- **響應式設計：** 適應螢幕大小，具水平滾動

### 5.2 **🆕 Excel下載檔案 (`delivery_estimates_PARTIAL_FULFILLMENT_TIMESTAMP.xlsx`)**
**完整欄位 (重新排序)：**
- 訂單號碼、客戶代碼、PO、項目、零件編號、需求數量、需求日期
- **預估交貨日期**、**提貨日期**、可用數量、履約數量、剩餘數量
- PO建立日期、前置天數 (日)、狀態、備註、庫存前、庫存後
- 庫存使用、航班數量使用、航班詳情、倉庫備註

**檔案功能：**
- **自動調整欄寬：** 為可讀性優化的欄寬
- **時間戳記檔名：** 包含"PARTIAL_FULFILLMENT"識別碼
- **完整資料：** 具正確多日期格式的所有處理詳情
- **加強型欄位順序：** 優先資訊在前，技術詳情在後

### 5.3 **🆕 加強型狀態值**
- **"現貨中"** - 完全從現有庫存履行 (單一交貨日期)
- **"部分庫存 + 航班"** - 使用庫存和航班的混合履行 (多重交貨日期)
- **"等待航班"** - 完全從航班抵達履行 (可能多重交貨日期)
- **"僅部分庫存"** - 僅使用可用庫存的部分履行
- **"僅部分航班"** - 僅使用可用航班的部分履行
- **"無庫存可用"** - 無目前庫存或未來航班可用
- **"無效日期"** - 無法解析需求日期的訂單

### 5.4 **🆕 加強型摘要統計**
**即時儀表板：**
- **訂單總數**、**完全履約**、**部分履約**、**無庫存**
- **現貨中**、**使用未來航班** (基於航班履約的訂單數量)
- 依客戶代碼的**客戶細分**
- 基於實際庫存可用性和消耗的**實際分配細分**

### 5.5 **🆕 加強型倉庫備註格式**
**多重交貨情境：**
- **僅庫存：** `"300 來自庫存 → 2025-08-01"`
- **僅航班：** `"500 來自航班 2025-08-15 (+10d) → 2025-08-22"`
- **混合履約：** `"200 來自庫存 → 2025-08-01; 300 來自航班 2025-08-15 (+10d) → 2025-08-22; 500 來自航班 2025-08-25 (+20d) → 2025-09-02"`
- **無履約：** `"無庫存可用 - 無目前庫存或未來航班"`

### 5.6 **🆕 加強型處理記錄**
**具詳細追蹤的即時控制台：**
- 加強型排序通知：`"以FIFO序列處理278個訂單 (需求日期 → PO建立日期)"`
- **多層級排序決策：** 顯示主要和次要排序結果
- **部分履約追蹤：** 即時庫存消耗和分配決策
- **多重日期計算：** 每個航班的個別提貨和交貨日期計算
- **庫存追蹤準確性：** 每個訂單前後的目前庫存水準
- 具特定分配詳情的錯誤訊息和警告

## 6. 技術規格

### 6.1 **瀏覽器相容性**
- **支援瀏覽器：** Chrome 90+、Firefox 88+、Safari 14+、Edge 90+
- **JavaScript功能：** ES6+、FileReader API、Blob API
- **CSS功能：** Grid、Flexbox、CSS變數、懸停效果
- **無需外掛：** 純HTML/CSS/JavaScript

### 6.2 **🆕 加強型多層級排序實作**
```javascript
// 具次要PO建立日期排序的加強型排序
const sortedOrders = [...orders].sort((a, b) => {
    // 處理無效日期
    if (!a.hasValidDate() && b.hasValidDate()) return 1;
    if (a.hasValidDate() && !b.hasValidDate()) return -1;
    if (!a.hasValidDate() && !b.hasValidDate()) return a.orderNumber - b.orderNumber;
    
    // 主要排序：需求日期升序
    const requestDateDiff = a.requestDate.getTime() - b.requestDate.getTime();
    if (requestDateDiff !== 0) return requestDateDiff;
    
    // 次要排序：PO建立日期升序
    if (a.poCreateDate && b.poCreateDate) {
        return a.poCreateDate.getTime() - b.poCreateDate.getTime();
    } else if (a.poCreateDate && !b.poCreateDate) {
        return -1; // 有效PO日期在無效之前
    } else if (!a.poCreateDate && b.poCreateDate) {
        return 1; // 無效PO日期在有效之後
    }
    
    // 第三排序：訂單號碼
    return a.orderNumber - b.orderNumber;
});
```

### 6.3 **🆕 部分履約分配邏輯**
```javascript
// 具多重日期追蹤的部分履約
function tryPartialAllocation(order, availableStock, availableFlights) {
    const pullingDates = [];
    const deliveryDates = [];
    
    // 首先使用可用庫存與交貨日期計算
    if (stockOnHand > 0) {
        stockUsed = Math.min(stockOnHand, order.requiredQuantity);
        
        // 計算庫存交貨日期
        let stockDeliveryDate = new Date(order.requestDate);
        // 應用緩衝和工作日邏輯
        deliveryDates.push({
            quantity: stockUsed,
            date: stockDeliveryDate,
            type: 'stock'
        });
    }
    
    // 使用所有可用的未來航班
    for (const flight of flights) {
        if (remainingNeeded <= 0) break;
        if (!flight.arrivalDate) continue; // 跳過無法解析日期
        
        // 接受任何未來航班 (無緩衝限制)
        const quantityToUse = Math.min(flight.quantity, remainingNeeded);
        if (quantityToUse > 0) {
            const flightPullingDate = calculatePullingDate(flight.arrivalDate);
            const flightDeliveryDate = calculateDeliveryFromPulling(flightPullingDate);
            
            pullingDates.push({
                quantity: quantityToUse,
                date: flightPullingDate,
                flightDate: flight.arrivalDate
            });
            
            deliveryDates.push({
                quantity: quantityToUse,
                date: flightDeliveryDate,
                type: 'flight',
                flightDate: flight.arrivalDate
            });
        }
    }
}
```

### 6.4 **🆕 多重日期顯示實作**
```javascript
// 格式化多重交貨日期
multipleDeliveryDates = sortedDeliveryDates.map(item => {
    const dateStr = formatDate(item.date);
    if (item.type === 'stock') {
        return `${item.quantity}×${dateStr} (現貨)`;
    } else {
        return `${item.quantity}×${dateStr} (航班)`;
    }
}).join(', ');

// 格式化多重提貨日期 (僅航班)
if (sortedPullingDates.length > 0) {
    multiplePullingDates = sortedPullingDates.map(item => {
        return `${item.quantity}×${formatDate(item.date)}`;
    }).join(', ');
} else {
    multiplePullingDates = null; // 僅庫存訂單
}
```

## 7. 分配演算法

### 7.1 **🆕 加強型處理流程 (具多重日期的部分履約)**
1. **檔案上傳與驗證：** 使用者選取檔案，系統驗證並顯示資訊
2. **配置更新：** 處理前讀取目前UI設定
3. **資料載入：** 具加強型錯誤處理和除錯的Excel檔案解析
4. **🆕 加強型訂單排序：** 多層級排序 (需求日期 → PO建立日期 → 訂單號碼)
5. **庫存初始化：** 為消耗追蹤建立工作副本
6. **🆕 部分履約分配：** 以最大履約邏輯處理每個訂單
7. **🆕 多重日期計算：** 計算每個航班的個別提貨和交貨日期
8. **庫存消耗：** 每個訂單減少後續訂單的可用庫存
9. **🆕 加強型結果生成：** 格式化多重日期並重新排序欄位
10. **UI更新：** 顯示具新欄位順序和多日期支援的結果
11. **下載準備：** 為具加強型欄位結構的Excel匯出格式化資料

### 7.2 **🆕 部分履約分配邏輯**
1. **加強型零件匹配：** 使用限制性模糊匹配 (精確 + "-A"後綴僅)
2. **庫存優先分配：** 使用可用庫存並立即計算交貨日期
3. **未來航班新增：** 接受所有未來航班，不受時間限制
4. **個別日期計算：** 計算每個使用航班的提貨和交貨日期
5. **庫存消耗：** 為下個訂單扣除已消耗數量
6. **多重日期格式化：** 為多重交貨情境生成顯示字串
7. **狀態分類：** 基於履約方式和完整性的加強型狀態

### 7.3 **🆕 加強型即時處理回饋**
- **加強型進度條：** 具多階段處理的視覺指示
- **詳細即時記錄：** 具FIFO排序決策和多重日期計算的控制台樣式更新
- **庫存消耗追蹤：** 即時庫存和航班水準更新
- **多重日期生成：** 顯示複雜訂單的個別日期計算
- **效能優化：** 具詳細記錄的客戶端處理

## 8. 錯誤處理與驗證

### 8.1 **檔案驗證**
- **檔案類型檢查：** 確保.xlsx/.xls副檔名
- **檔案大小顯示：** 向使用者顯示檔案大小
- **空檔案偵測：** 如果檔案看似空白則警告
- **欄位偵測：** 具後備的彈性標頭匹配

### 8.2 **🆕 加強型資料驗證**
- **日期解析：** 優雅處理多種日期格式
- **多重日期驗證：** 確保所有計算日期都是有效的台灣工作日
- **庫存消耗追蹤：** 驗證庫存水準保持非負數
- **航班日期處理：** 分配前驗證所有航班日期
- **缺失資料處理：** 使用適當的後備值

### 8.3 **🆕 加強型處理驗證**
- **排序驗證：** 記錄多層級排序決策以供驗證
- **分配數學：** 驗證部分履約計算
- **多重日期邏輯：** 驗證提貨和交貨日期計算
- **庫存一致性：** 監控整個FIFO處理期間的庫存水準
- **狀態分類：** 確保基於履約方式的準確狀態指派

## 9. 部署與使用

### 9.1 **部署模式**
- **單一檔案：** 完整應用程式在一個HTML檔案中 (delivery_estimator_v2.7_PARTIAL_FULFILLMENT.html)
- **CDN相依性：** SheetJS函式庫從CloudFlare CDN載入
- **無需伺服器：** 完全在客戶端執行
- **分發：** 電子郵件、網頁主機或檔案分享
- **版本控制：** 檔案名稱內的自包含版本控制

### 9.2 **🆕 加強型使用者指南**
1. **開啟檔案：** 雙擊HTML檔案或在瀏覽器中開啟
2. **上傳檔案：** 選取所有必要的Excel檔案 (訂單、庫存、航班)
3. **配置設定：** 如需要調整參數 (緩衝天數預設 = 0)
4. **處理：** 點擊"計算交貨日期"以進行部分履約邏輯
5. **監控進度：** 觀看具排序和分配決策的加強型處理記錄
6. **檢視結果：** 檢查具新欄位順序和多重日期的實際摘要統計
7. **下載：** 儲存具PARTIAL_FULFILLMENT時間戳記和加強型結構的Excel結果檔案

### 9.3 **系統需求**
- **瀏覽器：** 任何現代瀏覽器 (參見相容性清單)
- **記憶體：** 足夠RAM進行檔案處理 (通常100MB+可用)
- **儲存：** 檔案下載的暫時空間
- **網路：** 僅初始CDN函式庫載入需要網際網路連線
- **檔案系統：** Excel下載的本地檔案存取

## 10. 驗證檢查清單

驗證基於瀏覽器的結果時，檢查：
- [ ] **檔案上傳：** 所有三種檔案類型成功上傳並視覺確認
- [ ] **🆕 加強型排序：** 訂單按需求日期、PO建立日期、訂單號碼排序
- [ ] **配置：** UI設定正確影響計算 (零緩衝預設)
- [ ] **無法解析日期：** 無效日期的訂單以"無效日期"狀態處理
- [ ] **🆕 部分履約：** 所有訂單已處理，因庫存不足無訂單跳過
- [ ] **🆕 未來航班使用：** 系統接受並使用任何未來航班，不受時間限制
- [ ] **🆕 多重日期顯示：** 多個航班的訂單顯示多重提貨和交貨日期
- [ ] **🆕 欄位排序：** 優先欄位出現在前 (訂單#、客戶代碼、PO、項目、零件編號等)
- [ ] **庫存消耗追蹤：** 庫存前/後欄位顯示通過FIFO序列的正確進展
- [ ] **台灣日曆整合：** 所有日期計算使用台灣工作日曆
- [ ] **加強型提貨邏輯：** 提貨日期遵守週一/三規則和台灣工作日
- [ ] **零緩衝預設：** 現貨訂單當日或下一工作日交貨
- [ ] **零件匹配：** 僅允許精確匹配或"-A"後綴變體
- [ ] **🆕 加強型結果顯示：** 摘要統計顯示實際部分履約細分
- [ ] **🆕 Excel下載：** 下載檔案包含具多重日期格式的重新排序欄位
- [ ] **🆕 加強型處理記錄：** 排序決策、分配過程和多重日期計算的詳細記錄
- [ ] **錯誤處理：** 無效資料的適當處理，變數範圍問題已解決
- [ ] **🆕 多日期懸停：** 日期欄位懸停展開顯示完整詳情

## 11. v2.7的主要改進

### 11.1 **🆕 部分履約邏輯**
- **不再跳過訂單：** 每個訂單都會處理並盡可能最大程度履行
- **未來航班利用：** 系統接受任何未來航班以最大化履約
- **最大庫存使用：** 最佳使用所有可用庫存和航班
- **加強型客戶服務：** 啟用部分出貨和更好的交貨溝通

### 11.2 **🆕 多重交貨日期支援**
- **個別航班追蹤：** 每個使用的航班產生自己的提貨和交貨日期
- **混合履約顯示：** 庫存 + 多重航班組合的清楚視覺化
- **加強型規劃：** 啟用多重交貨階段的協調
- **物流優化：** 管理複雜履約情境的詳細時程表

### 11.3 **🆕 加強型FIFO排序**
- **多層級排序：** 需求日期 → PO建立日期 → 訂單號碼
- **公平處理：** 相同需求日期的訂單按PO建立時間排序
- **可預測優先權：** 一致的邏輯訂單處理序列
- **業務對齊：** 反映真實業務優先權實務

### 11.4 **🆕 改善的使用者介面**
- **優先欄位順序：** 最重要資訊首先顯示
- **多重日期視覺化：** 複雜日期資訊的懸停展開
- **加強型統計：** 部分履約結果的實際細分
- **更好的可用性：** 邏輯資訊流和使用者友善設計

### 11.5 **🆕 技術加強**
- **變數範圍修正：** 解決多重日期處理的JavaScript錯誤
- **加強型除錯：** 改善庫存和航班資料載入的記錄
- **準確庫存追蹤：** 修正"庫存前/後"欄位以顯示真實消耗
- **效能優化：** 高效的多日期計算和顯示

### 11.6 **業務效益**
- ✅ **營收最大化：** 盡可能最大程度履行每個訂單
- ✅ **改善客戶滿意度：** 交貨時程表的清楚溝通
- ✅ **庫存優化：** 使用所有可用庫存和未來航班
- ✅ **作業效率：** 倉庫作業的詳細規劃
- ✅ **實際期望：** 準確的交貨日期溝通
- ✅ **部分出貨：** 啟用可用數量的交貨而不等待

## 12. 瀏覽器專用功能

### 12.1 **檔案處理**
- **多檔案上傳：** 同時選取所有訂單檔案
- **加強型驗證：** 具改善錯誤處理的即時回饋
- **進度追蹤：** 具詳細多階段處理的視覺進度
- **記憶體管理：** 具複雜日期計算的大型Excel檔案高效處理

### 12.2 **互動元素**
- **🆕 多重日期顯示：** 檢視完整交貨時程表的懸停展開
- **加強型響應式設計：** 所有裝置大小的最佳顯示
- **改善色彩編碼：** 部分履約狀態的加強視覺指示器
- **進階工具提示：** 複雜多日期情境的詳細資訊

### 12.3 **🆕 加強型結果顯示**
- **實際摘要統計：** 基於實際部分履約結果
- **多重日期格式化：** 複雜交貨時程表的專業顯示
- **優先欄位順序：** 重要資訊立即可見
- **互動式除錯：** 可透過介面存取的處理記錄以進行故障排除

### 12.4 **資料匯出**
- **加強型下載：** 具改善檔案名稱結構的瀏覽器原生下載
- **多重日期匯出：** 複雜交貨時程表的完整保存
- **欄位重新排序：** Excel匯出符合瀏覽器顯示優先權
- **專業格式化：** 客戶溝通的業務就緒輸出

---

**目前版本：** 此部分履約版本 v2.7 代表訂單處理能力的重大進展。系統現在使用所有可用庫存來源盡可能最大程度履行訂單，提供詳細的多重交貨日期追蹤，並實作加強型多層級排序以進行公平的訂單優先權排序。

**關鍵創新：** 具多重交貨日期支援的部分履約邏輯實作使企業能夠最大化訂單履約，並為跨多個庫存來源和交貨時間範圍的複雜訂單提供準確的交貨時程表。

**業務影響：** 此版本將系統從簡單的交貨計算器轉變為全面的履約規劃工具，可以：
- **最大化營收**：沒有訂單未被履行 - 每個可用的庫存都被利用
- **改善客戶溝通**：為部分出貨提供準確、詳細的交貨時程表
- **優化作業**：清楚的倉庫提貨時程表和交貨協調
- **加強規劃**：多階段交貨可見性啟用更好的物流協調

**技術卓越**：加強型FIFO排序具次要PO日期優先權，結合即時庫存消耗追蹤和多重交貨日期計算，提供系列中最複雜和準確的訂單處理邏輯。

**使用者體驗**：重新排序的欄位顯示優先重要資訊，同時維持完整技術細節存取，懸停展開的多日期欄位根據需要提供概覽和詳細資訊。

## 13. 未來加強機會

### 13.1 **潛在附加功能**
- **客戶優先權加權**：在FIFO排序中加入客戶特定優先權倍數
- **庫存預留**：允許訂單在分配前預留未來航班數量
- **分批出貨優化**：最小化交貨次數同時最大化履約的演算法
- **基於成本的分配**：在分配決策中考慮航班成本和儲存成本
- **即時API整合**：連接到即時庫存和航班時程表系統

### 13.2 **進階分析**
- **履約率分析**：隨時間追蹤效能指標
- **客戶滿意度評分**：基於交貨日期準確性和履約完整性
- **庫存周轉優化**：庫存水準改善建議
- **航班利用報告**：航班容量使用和效率分析

### 13.3 **整合可能性**
- **ERP系統連接**：與企業資源規劃系統直接整合
- **倉庫管理系統**：與WMS即時協調提貨時程表
- **客戶入口網站整合**：直接與客戶系統進行交貨日期溝通
- **運輸管理**：與TMS協調以進行交貨路線優化

## 14. 技術架構備註

### 14.1 **效能考量**
- **客戶端處理**：所有計算在本地執行以確保安全性和速度
- **記憶體優化**：以最小記憶體佔用高效處理大型資料集
- **漸進增強**：核心功能在所有瀏覽器中運作，現代瀏覽器具加強功能
- **可擴展性**：高效處理跨多個客戶的數百個訂單

### 14.2 **安全功能**
- **無資料傳輸**：所有處理在本地發生 - 無資料發送到外部伺服器
- **檔案驗證**：全面輸入驗證以防止惡意檔案處理
- **記憶體管理**：自動清理已處理資料以防止記憶體洩漏
- **錯誤隔離**：強健的錯誤處理防止無效資料造成系統崩潰

### 14.3 **維護與支援**
- **自包含**：除CDN函式庫載入外無外部相依性
- **版本控制**：完整版本資訊嵌入檔案名稱和介面
- **除錯能力**：全面記錄以進行故障排除和驗證
- **文件**：完整規格和使用者指導嵌入程式碼註解

## 15. 合規與標準

### 15.1 **日期標準**
- **ISO 8601合規**：所有日期顯示遵循國際標準 (YYYY-MM-DD)
- **區域日曆支援**：台灣ROC日曆整合以符合本地業務規範
- **時區處理**：一致的本地時間處理以防止日期偏移錯誤
- **營業日標準**：台灣工作日定義與政府法規對齊

### 15.2 **資料標準**
- **Excel相容性**：完全支援.xlsx和.xls格式，具適當編碼
- **Unicode支援**：處理零件號碼和描述中的國際字元
- **數值精度**：具適當四捨五入的準確數量計算
- **文字編碼**：多語言資料處理的UTF-8支援

### 15.3 **可訪問性標準**
- **鍵盤導航**：透過鍵盤可完全存取功能
- **螢幕閱讀器支援**：輔助技術的語義HTML結構
- **色彩可訪問性**：高對比度比率和色盲友善狀態指示器
- **響應式設計**：在所有裝置大小上保持可訪問性

---

**版本歷史：**
- **v2.6**：具零緩衝預設和固定航班日期的REAL FIFO分配
- **v2.7**：具多重交貨日期、加強型排序和欄位重新排序的部分履約

**部署檔案**：`delivery_estimator_v2.7_PARTIAL_FULFILLMENT.html`

**支援**：此綜合規格書既作為交貨日期估算器 v2.7 部分履約版本的技術文件也作為使用者指南，使企業能夠實作具最大庫存利用和詳細交貨排程能力的複雜訂單履約規劃。
